{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",

    "variables": {
        "springCloudSkuName": "S0",
        "springCloudSkuTier": "Standard",        
        "location": "[resourceGroup().location]",
        "diagApiVersion": "2017-05-01-preview",
        "springApiVersion": "2020-07-01",
        "appInsightsApiVersion": "2020-02-02-preview"
    },
    "parameters": {
         
        "vnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the subnet for spring cloud runtime"
            }
        },   

        "vnetResourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup()]",
            "metadata": {
                "description": "Name of the subnet for spring cloud runtime"
            }
        },

        "runtimeSubnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the subnet for spring cloud runtime"
            }
        },

        "appSubnetName": {
            "type": "string",
            "metadata": {
                "description": "Name of the subnet for spring cloud app"
            }
        },

        // workspace parameters
        "workspaceName": {
          "type": "string",
          "metadata": {
            "description": "Name of the workspace."
          }
        },
        "workspaceSku": {
          "type": "string",
          "allowedValues": [
            "pergb2018",
            "Free",
            "Standalone",
            "PerNode",
            "Standard",
            "Premium"
            ],
          "defaultValue": "pergb2018",
          "metadata": {
          "description": "Pricing tier: PerGB2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
          }
        },
        "retentionInDays": {
          "type": "int",
          "defaultValue": 120,
          "metadata": {
            "description": "Number of days to retain data."
          }
        },
        "resourcePermissions": {
          "type": "bool",
          "metadata": {
            "description": "true to use resource or workspace permissions. false to require workspace permissions."
          }
        },
        "heartbeatTableRetention": {
          "type": "int",
          "metadata": {
            "description": "Number of days to retain data in Heartbeat table."
          }
        },
        "springCloudInstanceName": {
            "type": "string",
            "metadata": {
                "description": "The instance name of the Azure Spring Cloud resource"
            }
        },
        "appInsightsName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Application Insights instance for Azure Spring Cloud"
            }
        },
        "springCloudServiceCidrs": {
            "type": "string",
            "defaultValue": "10.0.0.0/16,10.2.0.0/16,10.3.0.1/16",
            "metadata": {
                "description": "Comma-separated list of IP address ranges in CIDR format. The IP ranges are reserved to host underlying Azure Spring Cloud infrastructure, which should be 3 at least /16 unused IP ranges, must not overlap with any Subnet IP ranges"
            }
            
        },
        
        "tags": {
            "type": "object",
            "metadata": {
                "description": "The tags that will be associated to the Resources"
            },
            "defaultValue": {
                "environment": "lab"
            }
        }
    },

    "resources": [
    {
        // workspace
        "type": "Microsoft.OperationalInsights/workspaces",
        "name": "[parameters('workspaceName')]",
        "apiVersion": "2020-08-01",
        "location": "[variables('location')]",
        "properties": {
            "sku": {
                "name": "[parameters('workspaceSku')]"
            },
            "retentionInDays": "[parameters('retentionInDays')]",
            "features": {
                "enableLogAccessUsingOnlyResourcePermissions": "[parameters('resourcePermissions')]"
            }
        },
        "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/tables",
            "apiVersion": "2020-08-01",
            "name": "[concat(parameters('workspaceName'),'/','Heartbeat')]",
            "dependsOn": [
                "[parameters('workspaceName')]"
            ],
            "properties": {
                "RetentionInDays": "[parameters('heartbeatTableRetention')]"
            }
        }
        ]
    },    
    {  // Spring Cloud - application insights
        "type": "Microsoft.Insights/components",
        "name": "[parameters('appInsightsName')]",
        "apiVersion": "[variables('appInsightsApiVersion')]",
        "location": "[variables('location')]",
        "tags": "[parameters('tags')]",
        "dependsOn": [
            "[resourceId('Microsoft.OperationalInsights/workspaces',parameters('workspaceName'))]"
        ],
        "properties": {
            "Application_Type": "web",
            "ApplicationId": "[parameters('appInsightsName')]",
            "Flow_Type": "Bluefield",
            "Request_Source": "rest",
            "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces',parameters('workspaceName'))]"
        }
    },
    {  // Spring Cloud
        "apiVersion": "[variables('springApiVersion')]",
        "name": "[parameters('springCloudInstanceName')]",
        "location": "[variables('location')]",
        "tags": "[parameters('tags')]",
        "dependsOn": [
            "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
        ],
        "type": "Microsoft.AppPlatform/Spring",
        "sku": {
            "name": "[variables('springCloudSkuName')]",
            "tier": "[variables('springCloudSkuTier')]"
        },
        "properties": {
            "networkProfile": {
                "serviceCidr": "[parameters('springCloudServiceCidrs')]",
                "serviceRuntimeSubnetId": "[concat('/subscriptions/', subscription(), '/resourceGroups/', parameters('vnetResourceGroupName') ,'/providers/Microsoft.Network/virtualNetworks/', parameters('vnetName') ,'/subnets/', parameters('runtimeSubnetName'))]",
                "appSubnetId": "[concat('/subscriptions/', subscription(), '/resourceGroups/', parameters('vnetResourceGroupName') ,'/providers/Microsoft.Network/virtualNetworks/', parameters('vnetName') ,'/subnets/', parameters('appSubnetName'))]"
            }
        }
    },
    {  // Spring Cloud - monitoring setting
        "apiVersion": "[variables('springApiVersion')]",
        "name": "[concat(parameters('springCloudInstanceName'), '/default')]",
        "type": "Microsoft.AppPlatform/Spring/monitoringSettings",
        "properties": {
            "traceEnabled": true,
            "appInsightsInstrumentationKey": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), variables('appInsightsApiVersion')).InstrumentationKey]"
        },
        "dependsOn": [
            "[resourceId('Microsoft.AppPlatform/Spring/', parameters('springCloudInstanceName'))]"
        ]
    },
    {
        "type": "Microsoft.AppPlatform/Spring/providers/diagnosticSettings",
        "name": "[concat(parameters('springCloudInstanceName'), '/Microsoft.Insights/monitoring')]",
        "dependsOn": [  
            "[resourceId('Microsoft.AppPlatform/Spring/', parameters('springCloudInstanceName'))]"       
        ],
        "apiVersion": "[variables('diagApiVersion')]",
        "properties": {
            "name": "monitoring",
            "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces',parameters('workspaceName'))]",
            "logs": [
                {
                    "category": "ApplicationConsole",
                    "enabled": true,
                    "retentionPolicy": {
                        "days": 30,
                        "enabled": false
                    }
                }
            ]
        }
    }


    // { // azure spring cloud
    //     "name": "azureSpringCloud",
    //     "type": "Microsoft.Resources/deployments",
    //     "apiVersion": "2021-04-01",
    //     "dependsOn": [
    //         "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]",
    //         "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
    //         "[concat('/subscriptions/', subscription().subscriptionId ,'/resourceGroups/', resourceGroup().name ,'/providers/Microsoft.Network/virtualNetworks/', parameters('vnetName') ,'/providers/Microsoft.Authorization/roleAssignments/', variables('roleAssignmentName'))]"
    //     ],
    //     "properties": {
    //         "mode": "Incremental",
    //         "templateLink": {
    //             //"relativePath": "artifacts/azureSpringCloud.json"
    //              "uri": "https://raw.githubusercontent.com/LyleXu/autoprovision/main/artifacts/azureSpringCloud.json"
    //         },
    //         "parameters": {
    //             "springCloudInstanceName": {
    //                 "value": "[parameters('springCloudInstanceName')]"
    //             },
    //             "appInsightsName": {
    //                 "value": "[parameters('appInsightsName')]"
    //             },
    //             "springCloudServiceCidrs": {
    //                 "value": "10.1.0.0/16,10.2.0.0/16,10.3.0.1/16"
    //             },
    //             "laWorkspaceResourceId": {
    //                 "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
    //             },
    //             "springCloudAppSubnetID": {
    //                 "value": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '/subnets/', parameters('appSubnetName'))]"
    //             },
    //             "springCloudRuntimeSubnetID": {
    //                 "value": "[concat(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '/subnets/', parameters('runtimeSubnetName'))]"
    //             }
    //         }
    //     }
    // }
    
    //,
    // { // log analytics
    //     "name": "logAnalytics",
    //     "type": "Microsoft.Resources/deployments",
    //     "apiVersion": "2021-04-01",
    //     "properties": {
    //         "mode": "Incremental",
    //         "templateLink": {
    //             //"relativePath": "artifacts/logAnalytics.json"
    //             "uri": "https://raw.githubusercontent.com/LyleXu/autoprovision/main/artifacts/logAnalytics.json"
    //         },
    //         "parameters": {
    //             "workspaceName": {
    //                 "value": "[parameters('workspaceName')]"
    //             },
    //             "sku": {
    //                 "value": "pergb2018"
    //             },
    //             "resourcePermissions": {
    //                 "value": true
    //             },
    //             "heartbeatTableRetention": {
    //                 "value": 30
    //             }
    //         }
    //     }
    // },
    // { // azure spring cloud
    //     "name": "azureSpringCloud",
    //     "type": "Microsoft.Resources/deployments",
    //     "apiVersion": "2021-04-01",
    //     "properties": {
    //         "mode": "Incremental",
    //         "templateLink": {
    //             //"relativePath": "artifacts/azureSpringCloud.json"
    //              "uri": "https://raw.githubusercontent.com/LyleXu/autoprovision/main/artifacts/azureSpringCloud.json"
    //         },
    //         "parameters": {
    //             "springCloudInstanceName": {
    //                 "value": "[parameters('springCloudInstanceName')]"
    //             },
    //             "appInsightsName": {
    //                 "value": "[parameters('appInsightsName')]"
    //             },
    //             "springCloudServiceCidrs": {
    //                 "value": "10.1.0.0/16,10.2.0.0/16,10.3.0.1/16"
    //             },
    //             "laWorkspaceResourceId": {
    //                 "value": "[reference('logAnalytics').outputs.laWorkspaceId.value]"
    //             },
    //             "springCloudAppSubnetID": {
    //                 "value": "[reference('vnet').outputs.appSubnetId.value]"
    //             },
    //             "springCloudRuntimeSubnetID": {
    //                 "value": "[reference('vnet').outputs.runtimeSubnetId.value]"
    //             }
    //         }
    //     }
    // },
    // { // mysql
    //     "name": "mysql",
    //     "type": "Microsoft.Resources/deployments",
    //     "apiVersion": "2021-04-01",
    //     "properties": {
    //         "mode": "Incremental",
    //         "templateLink": {
    //             "relativePath": "artifacts/database.json"
    //         },
    //         "parameters": {
    //             "serverName": {
    //                 "value": "dbmysqldev001"
    //             },
    //             "administratorLogin": {
    //                 "value": "testascdev"
    //             },
    //             "administratorLoginPassword": {
    //                 "value": "Welcome1"
    //             }
    //         }
    //     }
    // }

    ]
    
  }